<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inverting Op-Amp Calculator</title>
    <link rel="stylesheet" href="../common.css">
</head>
<body>
    <h1>Inverting Op-Amp Calculator</h1>
    <p class="intro">
        Design an inverting amplifier using an op-amp. The output is 180° out of phase
        with the input, and gain is set by the ratio of two resistors.
    </p>

    <h2>Inputs</h2>
    <table>
        <tr>
            <td>Desired gain:</td>
            <td><input type="number" id="gain" value="10" step="1" min="1"> V/V</td>
        </tr>
        <tr>
            <td>Input (peak):</td>
            <td><input type="number" id="vin" value="100" step="10" min="1"> mV</td>
        </tr>
        <tr>
            <td>Input impedance (Rin):</td>
            <td><input type="number" id="rin" value="10000" step="1000" min="100"> Ω</td>
        </tr>
        <tr>
            <td>Supply voltage (±):</td>
            <td><input type="number" id="vcc" value="12" step="1" min="5"> V</td>
        </tr>
    </table>

    <button onclick="calculate()">Calculate</button>
    <button onclick="resetDefaults()" style="margin-left: 10px;">Reset</button>

    <div id="warning" style="display: none;"></div>

    <div id="results">
        <h2>Schematic</h2>
        <div id="schematic"></div>
        

        <h2>Calculated Values</h2>
        <table>
            <tr><td>Rin (input):</td><td id="rin_out"></td></tr>
            <tr><td>Rf (feedback):</td><td id="rf"></td></tr>
        </table>

        <h2>Performance</h2>
        <table>
            <tr><td>Gain:</td><td id="gainOut"></td></tr>
            <tr><td>Input impedance:</td><td id="zinOut"></td></tr>
            <tr><td>Expected output:</td><td id="voutOut"></td></tr>
            <tr><td>Max output swing:</td><td id="swingOut"></td></tr>
        </table>

        <p id="note" style="color: gray;"></p>
    </div>

    <script src="../common.js"></script>
    <script src="../schematic.js"></script>
    <script>
        function drawSchematic(rinRounded, rfRounded, vcc, actualGain, voutPeak, maxSwing) {
            const sch = new Schematic(420, 280);

            // Op-amp at center (minus on top for inverting config)
            sch.place('opamp', 'U1', 230, 130);

            // Rin: input resistor
            sch.place('resistor-h', 'Rin', 100, 110, { label: fmt(rinRounded, 'Ω') });

            // Rf: feedback resistor
            sch.place('resistor-h', 'Rf', 230, 50, { label: fmt(rfRounded, 'Ω') });

            // Ground for + input
            sch.place('ground', 'GND', 160, 175);

            // Input
            sch.label('In', 15, 114);
            sch.wire({ x: 30, y: 110 }, 'Rin.a');

            // Rin -> minus input
            sch.wire('Rin.b', { x: 160, y: 110 });
            sch.wire({ x: 160, y: 110 }, 'U1.minus');
            sch.node(160, 110);

            // Feedback: minus up -> Rf -> output
            sch.wire({ x: 160, y: 110 }, { x: 160, y: 50 });
            sch.wire({ x: 160, y: 50 }, 'Rf.a');
            sch.wire('Rf.b', { x: 310, y: 50 });
            sch.wire({ x: 310, y: 50 }, { x: 310, y: 130 });

            // Plus input to ground
            sch.wire('U1.plus', { x: 160, y: 150 }, { route: 'h-v' });
            sch.wire({ x: 160, y: 150 }, 'GND.a');

            // Output
            sch.wire('U1.out', { x: 370, y: 130 });
            sch.node(310, 130);
            sch.label('Out', 380, 134);

            // Power rails
            sch.wire('U1.vpos', { x: 230, y: 85 });
            sch.label('+' + vcc + 'V', 240, 82);
            sch.wire('U1.vneg', { x: 230, y: 175 });
            sch.label('−' + vcc + 'V', 240, 182);

            // Info display
            sch.label('Gain:', 20, 230, { bold: true });
            sch.label('Av = -' + actualGain.toFixed(1), 20, 250);
            sch.label('Output:', 150, 230, { bold: true });
            sch.label(fmtLong(voutPeak, 'V') + ' peak', 150, 250);
            sch.label('Swing:', 300, 230, { bold: true });
            sch.label('±' + maxSwing.toFixed(1) + 'V', 300, 250);

            return sch.toSVG();
        }

        function calculate() {
            const targetGain = parseFloat(document.getElementById('gain').value);
            const vin = parseFloat(document.getElementById('vin').value) / 1000;
            const rinTarget = parseFloat(document.getElementById('rin').value);
            const vcc = parseFloat(document.getElementById('vcc').value);

            // For inverting amp: Gain = -Rf / Rin
            // So Rf = Gain * Rin
            const rinRounded = roundToE24(rinTarget);
            const rfCalc = targetGain * rinRounded;
            const rfRounded = roundToE24(rfCalc);

            // Actual gain with rounded values
            const actualGain = rfRounded / rinRounded;

            // Output calculations
            const voutPeak = vin * actualGain;

            // Op-amp output swing is typically Vcc - 1 to 2V for standard op-amps
            const maxSwing = vcc - 1.5;

            let notes = [];

            // Warnings
            const warn = document.getElementById('warning');
            if (voutPeak > maxSwing) {
                warn.textContent = 'Warning: output (' + voutPeak.toFixed(2) + 'V peak) exceeds swing (±' + maxSwing.toFixed(1) + 'V). Signal will clip.';
                warn.style.display = 'block';
            } else {
                warn.style.display = 'none';
            }

            // High gain warning
            if (actualGain > 100) {
                notes.push('High gain may require attention to op-amp GBW product and stability.');
            }

            // Results
            document.getElementById('results').style.display = 'block';

            // Draw schematic
            document.getElementById('schematic').innerHTML = drawSchematic(rinRounded, rfRounded, vcc, actualGain, voutPeak, maxSwing);

            // Table values
            document.getElementById('rin_out').textContent = fmtLong(rinRounded, 'Ω');
            document.getElementById('rf').textContent = fmtLong(rfRounded, 'Ω');

            // Performance
            document.getElementById('gainOut').textContent = '-' + actualGain.toFixed(1) + ' V/V (inverting)';
            document.getElementById('zinOut').textContent = fmtLong(rinRounded, 'Ω');
            document.getElementById('voutOut').textContent = fmtLong(voutPeak, 'V') + ' peak';
            document.getElementById('swingOut').textContent = '±' + maxSwing.toFixed(1) + ' V';

            document.getElementById('note').textContent = notes.join(' ');
        }

        function resetDefaults() {
            document.getElementById('gain').value = '10';
            document.getElementById('vin').value = '100';
            document.getElementById('rin').value = '10000';
            document.getElementById('vcc').value = '12';
            calculate();
        }

        window.onload = calculate;
    </script>
</body>
</html>
