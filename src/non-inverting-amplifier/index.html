<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Non-Inverting Op-Amp Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    primary: '#2266cc',
                }
            }
        }
    }
    </script>
    <style>
        svg text { font-family: ui-monospace, monospace; }
    </style>
</head>
<body class="max-w-3xl mx-auto px-4 sm:px-6 py-8 font-sans leading-relaxed">
    <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-4">Non-Inverting Op-Amp Calculator</h1>
    <p class="text-gray-600 text-lg max-w-xl mb-6">
        Design a non-inverting amplifier using an op-amp. The output is in phase
        with the input, and offers very high input impedance.
    </p>

    <h2 class="text-xl font-semibold text-gray-600 mt-8 mb-4">Inputs</h2>
    <div class="overflow-x-auto">
        <table class="w-full sm:w-auto">
            <tr>
                <td class="py-2 pr-4">Desired gain:</td>
                <td class="py-2"><input type="number" id="gain" value="10" step="1" min="1" class="w-20 px-2 py-1 border border-gray-300 rounded text-sm"> V/V</td>
            </tr>
            <tr>
                <td class="py-2 pr-4">Input (peak):</td>
                <td class="py-2"><input type="number" id="vin" value="100" step="10" min="1" class="w-20 px-2 py-1 border border-gray-300 rounded text-sm"> mV</td>
            </tr>
            <tr>
                <td class="py-2 pr-4">R1 value:</td>
                <td class="py-2"><input type="number" id="r1" value="10000" step="1000" min="100" class="w-20 px-2 py-1 border border-gray-300 rounded text-sm"> &#8486;</td>
            </tr>
            <tr>
                <td class="py-2 pr-4">Supply voltage (±):</td>
                <td class="py-2"><input type="number" id="vcc" value="12" step="1" min="5" class="w-20 px-2 py-1 border border-gray-300 rounded text-sm"> V</td>
            </tr>
        </table>
    </div>

    <div class="flex flex-wrap gap-2 mt-4">
        <button onclick="calculate()" class="px-5 py-2 bg-primary text-white rounded hover:bg-blue-700 cursor-pointer text-sm">Calculate</button>
        <button onclick="resetDefaults()" class="px-5 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 cursor-pointer text-sm">Reset</button>
    </div>

    <div id="warning" class="hidden text-red-700 bg-red-50 border-l-4 border-red-600 p-4 my-4"></div>

    <div id="results">
        <h2 class="text-xl font-semibold text-gray-600 mt-8 mb-4">Schematic</h2>
        <div id="schematic" class="overflow-x-auto"></div>

        <h2 class="text-xl font-semibold text-gray-600 mt-8 mb-4">Calculated Values</h2>
        <div class="overflow-x-auto">
            <table class="w-full sm:w-auto">
                <tr><td class="py-2 pr-4">R1 (to ground):</td><td id="r1_out" class="py-2 text-right font-mono"></td></tr>
                <tr><td class="py-2 pr-4">Rf (feedback):</td><td id="rf" class="py-2 text-right font-mono"></td></tr>
            </table>
        </div>

        <h2 class="text-xl font-semibold text-gray-600 mt-8 mb-4">Performance</h2>
        <div class="overflow-x-auto">
            <table class="w-full sm:w-auto">
                <tr><td class="py-2 pr-4">Gain:</td><td id="gainOut" class="py-2 text-right font-mono"></td></tr>
                <tr><td class="py-2 pr-4">Input impedance:</td><td id="zinOut" class="py-2 text-right font-mono"></td></tr>
                <tr><td class="py-2 pr-4">Expected output:</td><td id="voutOut" class="py-2 text-right font-mono"></td></tr>
                <tr><td class="py-2 pr-4">Max output swing:</td><td id="swingOut" class="py-2 text-right font-mono"></td></tr>
            </table>
        </div>

        <p id="note" class="text-gray-500 mt-4"></p>
    </div>

    <script src="../common.js"></script>
    <script src="../schematic.js"></script>
    <script>
        function drawSchematic(r1Rounded, rfRounded, vcc, actualGain, voutPeak, maxSwing) {
            const sch = new Schematic(420, 280);

            // Op-amp with flip (+ on top for non-inverting input)
            sch.place('opamp', 'U1', 230, 110, { flip: true });

            // Rf: feedback resistor
            sch.place('resistor-h', 'Rf', 230, 35, { label: fmt(rfRounded, 'Ω') });

            // R1: to ground
            sch.place('resistor-v', 'R1', 160, 175, { label: fmt(r1Rounded, 'Ω') });
            sch.place('ground', 'GND', 160, 220);

            // Input to + (which is on top with flip)
            sch.label('In', 15, 94);
            sch.wire({ x: 30, y: 90 }, 'U1.plus');

            // Minus input -> junction -> R1 down, Rf up
            sch.wire('U1.minus', { x: 160, y: 130 }, { route: 'v-h' });
            sch.wire({ x: 160, y: 130 }, { x: 160, y: 140 });
            sch.node(160, 140);

            // R1 to ground
            sch.wire({ x: 160, y: 140 }, 'R1.a');
            sch.wire('R1.b', 'GND.a');

            // Feedback up to Rf
            sch.wire({ x: 160, y: 140 }, { x: 160, y: 35 });
            sch.wire({ x: 160, y: 35 }, 'Rf.a');
            sch.wire('Rf.b', { x: 310, y: 35 });
            sch.wire({ x: 310, y: 35 }, { x: 310, y: 110 });

            // Output
            sch.wire('U1.out', { x: 370, y: 110 });
            sch.node(310, 110);
            sch.label('Out', 380, 114);

            // Power rails
            sch.wire('U1.vpos', { x: 230, y: 65 });
            sch.label('+' + vcc + 'V', 240, 62);
            sch.wire('U1.vneg', { x: 230, y: 155 });
            sch.label('−' + vcc + 'V', 240, 162);

            // Info display
            sch.label('Gain:', 20, 240, { bold: true });
            sch.label('Av = +' + actualGain.toFixed(1), 20, 260);
            sch.label('Output:', 150, 240, { bold: true });
            sch.label(fmtLong(voutPeak, 'V') + ' peak', 150, 260);
            sch.label('Swing:', 300, 240, { bold: true });
            sch.label('±' + maxSwing.toFixed(1) + 'V', 300, 260);

            return sch.toSVG();
        }

        function calculate() {
            const targetGain = parseFloat(document.getElementById('gain').value);
            const vin = parseFloat(document.getElementById('vin').value) / 1000;
            const r1Target = parseFloat(document.getElementById('r1').value);
            const vcc = parseFloat(document.getElementById('vcc').value);

            // For non-inverting amp: Gain = 1 + Rf / R1
            // So Rf = (Gain - 1) * R1
            const r1Rounded = roundToE24(r1Target);
            const rfCalc = (targetGain - 1) * r1Rounded;
            const rfRounded = roundToE24(rfCalc);

            // Actual gain with rounded values
            const actualGain = 1 + rfRounded / r1Rounded;

            // Output calculations
            const voutPeak = vin * actualGain;

            // Op-amp output swing is typically Vcc - 1 to 2V for standard op-amps
            const maxSwing = vcc - 1.5;

            let notes = [];

            // Warnings
            const warn = document.getElementById('warning');
            if (voutPeak > maxSwing) {
                warn.textContent = 'Warning: output (' + fmtLong(voutPeak, 'V') + ' peak) exceeds swing (±' + fmtLong(maxSwing, 'V') + '). Signal will clip.';
                warn.classList.remove('hidden');
            } else {
                warn.classList.add('hidden');
            }

            // Gain of 1 warning
            if (targetGain <= 1) {
                notes.push('For unity gain (buffer), use Rf=0 and omit R1, or just wire output to inverting input.');
            }

            // High gain warning
            if (actualGain > 100) {
                notes.push('High gain may require attention to op-amp GBW product and stability.');
            }

            // Results
            document.getElementById('results').style.display = 'block';

            // Draw schematic
            document.getElementById('schematic').innerHTML = drawSchematic(r1Rounded, rfRounded, vcc, actualGain, voutPeak, maxSwing);

            // Table values
            document.getElementById('r1_out').textContent = fmtLong(r1Rounded, 'Ω');
            document.getElementById('rf').textContent = fmtLong(rfRounded, 'Ω');

            // Performance
            document.getElementById('gainOut').textContent = '+' + actualGain.toFixed(1) + ' V/V (non-inverting)';
            document.getElementById('zinOut').textContent = 'Very high (op-amp input impedance)';
            document.getElementById('voutOut').textContent = fmtLong(voutPeak, 'V') + ' peak';
            document.getElementById('swingOut').textContent = '±' + fmtLong(maxSwing, 'V');

            document.getElementById('note').textContent = notes.join(' ');
        }

        function resetDefaults() {
            document.getElementById('gain').value = '10';
            document.getElementById('vin').value = '100';
            document.getElementById('r1').value = '10000';
            document.getElementById('vcc').value = '12';
            calculate();
        }

        window.onload = calculate;
    </script>
</body>
</html>
