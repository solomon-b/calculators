<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CE Amplifier Calculator</title>
</head>
<body>
    <h1>CE Amplifier Calculator</h1>

    <h2>Inputs</h2>
    <table>
        <tr>
            <td>Vcc:</td>
            <td><input type="number" id="vcc" value="10" step="0.1" min="1"> V</td>
        </tr>
        <tr>
            <td>Desired loaded gain:</td>
            <td><input type="number" id="gain" value="10" step="1" min="1"> V/V</td>
        </tr>
        <tr>
            <td>Input (peak):</td>
            <td><input type="number" id="vin" value="100" step="10" min="1"> mV</td>
        </tr>
        <tr>
            <td>Source impedance:</td>
            <td><input type="number" id="zsource" value="0" step="100" min="0"> Ω</td>
        </tr>
        <tr>
            <td>Low frequency:</td>
            <td><input type="number" id="fLow" value="20" step="1" min="1"> Hz</td>
        </tr>
        <tr>
            <td>Load:</td>
            <td><input type="number" id="rload" value="10000" step="1000" min="1000"> Ω</td>
        </tr>
        <tr>
            <td>β (hFE):</td>
            <td><input type="number" id="beta" value="100" step="10" min="20"></td>
        </tr>
    </table>
    <br>
    <button onclick="calculate()">Calculate</button>

    <div id="warning" style="color: red; display: none; margin-top: 10px;"></div>

    <div id="results">
        <h2>Schematic</h2>
        <svg width="520" height="520" style="font-family: monospace; font-size: 12px;">
            <!-- Vcc rail -->
            <line x1="250" y1="20" x2="250" y2="40" stroke="black" stroke-width="2"/>
            <text x="250" y="15" text-anchor="middle">Vcc</text>
            
            <!-- Rc (collector resistor) -->
            <line x1="250" y1="40" x2="250" y2="50" stroke="black" stroke-width="2"/>
            <rect x="240" y="50" width="20" height="50" fill="none" stroke="black" stroke-width="2"/>
            <text x="270" y="80" id="schRc">Rc</text>
            <line x1="250" y1="100" x2="250" y2="120" stroke="black" stroke-width="2"/>
            
            <!-- Collector node to output cap -->
            <line x1="250" y1="120" x2="300" y2="120" stroke="black" stroke-width="2"/>
            <circle cx="250" cy="120" r="3" fill="black"/>
            
            <!-- Cout -->
            <line x1="300" y1="110" x2="300" y2="130" stroke="black" stroke-width="2"/>
            <line x1="310" y1="110" x2="310" y2="130" stroke="black" stroke-width="2"/>
            <text x="305" y="100" text-anchor="middle" id="schCout">Cout</text>
            
            <!-- Output -->
            <line x1="310" y1="120" x2="350" y2="120" stroke="black" stroke-width="2"/>
            <text x="360" y="124">Out</text>
            
            <!-- Load (external device) -->
            <line x1="350" y1="120" x2="350" y2="140" stroke="black" stroke-width="2"/>
            <circle cx="350" cy="120" r="3" fill="black"/>
            <rect x="340" y="140" width="20" height="50" fill="none" stroke="black" stroke-width="2" stroke-dasharray="4,2"/>
            <text x="370" y="170" id="schRload">Load</text>
            <line x1="350" y1="190" x2="350" y2="210" stroke="black" stroke-width="2" stroke-dasharray="4,2"/>
            <!-- Load ground -->
            <line x1="340" y1="210" x2="360" y2="210" stroke="black" stroke-width="2" stroke-dasharray="4,2"/>
            <line x1="343" y1="215" x2="357" y2="215" stroke="black" stroke-width="1" stroke-dasharray="4,2"/>
            <line x1="346" y1="220" x2="354" y2="220" stroke="black" stroke-width="1" stroke-dasharray="4,2"/>
            
            <!-- Transistor symbol -->
            <line x1="250" y1="120" x2="250" y2="135" stroke="black" stroke-width="2"/>
            <!-- Vertical base bar -->
            <line x1="220" y1="150" x2="220" y2="190" stroke="black" stroke-width="3"/>
            <!-- Base input line -->
            <line x1="190" y1="170" x2="220" y2="170" stroke="black" stroke-width="2"/>
            <!-- Collector line (angled up-right) -->
            <line x1="220" y1="155" x2="250" y2="135" stroke="black" stroke-width="2"/>
            <!-- Emitter line (angled down-right) with arrow -->
            <line x1="220" y1="185" x2="250" y2="205" stroke="black" stroke-width="2"/>
            <polygon points="244,198 250,205 242,203" fill="black"/>
            
            <!-- Emitter node down -->
            <line x1="250" y1="205" x2="250" y2="220" stroke="black" stroke-width="2"/>
            
            <!-- Re1 (unbypassed emitter resistor) -->
            <rect x="240" y="220" width="20" height="40" fill="none" stroke="black" stroke-width="2"/>
            <text x="270" y="245" id="schRe1">Re1</text>
            <line x1="250" y1="260" x2="250" y2="275" stroke="black" stroke-width="2"/>
            <circle cx="250" cy="275" r="3" fill="black"/>
            
            <!-- Re2 (bypassed emitter resistor) -->
            <rect x="240" y="275" width="20" height="40" fill="none" stroke="black" stroke-width="2"/>
            <text x="220" y="300" text-anchor="end" id="schRe2">Re2</text>
            <line x1="250" y1="315" x2="250" y2="330" stroke="black" stroke-width="2"/>
            
            <!-- Ce (bypass cap) - parallel to Re2 only -->
            <line x1="250" y1="275" x2="300" y2="275" stroke="black" stroke-width="2"/>
            <line x1="300" y1="275" x2="300" y2="290" stroke="black" stroke-width="2"/>
            <line x1="290" y1="290" x2="310" y2="290" stroke="black" stroke-width="2"/>
            <line x1="290" y1="298" x2="310" y2="298" stroke="black" stroke-width="2"/>
            <text x="320" y="298" id="schCe">Ce</text>
            <line x1="300" y1="298" x2="300" y2="315" stroke="black" stroke-width="2"/>
            <line x1="250" y1="315" x2="300" y2="315" stroke="black" stroke-width="2"/>
            <circle cx="250" cy="315" r="3" fill="black"/>
            
            <!-- Ground under Re2 -->
            <line x1="240" y1="330" x2="260" y2="330" stroke="black" stroke-width="2"/>
            <line x1="243" y1="335" x2="257" y2="335" stroke="black" stroke-width="1"/>
            <line x1="246" y1="340" x2="254" y2="340" stroke="black" stroke-width="1"/>
            
            <!-- Bias network R1 -->
            <line x1="140" y1="20" x2="140" y2="40" stroke="black" stroke-width="2"/>
            <line x1="140" y1="20" x2="250" y2="20" stroke="black" stroke-width="2"/>
            <rect x="130" y="40" width="20" height="50" fill="none" stroke="black" stroke-width="2"/>
            <text x="160" y="70" id="schR1">R1</text>
            <line x1="140" y1="90" x2="140" y2="170" stroke="black" stroke-width="2"/>
            
            <!-- Connect R1 to base -->
            <line x1="140" y1="170" x2="190" y2="170" stroke="black" stroke-width="2"/>
            <circle cx="140" cy="170" r="3" fill="black"/>
            
            <!-- Bias network R2 -->
            <line x1="140" y1="170" x2="140" y2="190" stroke="black" stroke-width="2"/>
            <rect x="130" y="190" width="20" height="50" fill="none" stroke="black" stroke-width="2"/>
            <text x="160" y="220" id="schR2">R2</text>
            <line x1="140" y1="240" x2="140" y2="260" stroke="black" stroke-width="2"/>
            
            <!-- Ground under R2 -->
            <line x1="130" y1="260" x2="150" y2="260" stroke="black" stroke-width="2"/>
            <line x1="133" y1="265" x2="147" y2="265" stroke="black" stroke-width="1"/>
            <line x1="136" y1="270" x2="144" y2="270" stroke="black" stroke-width="1"/>
            
            <!-- Input coupling cap Cin -->
            <line x1="50" y1="170" x2="70" y2="170" stroke="black" stroke-width="2"/>
            <line x1="70" y1="160" x2="70" y2="180" stroke="black" stroke-width="2"/>
            <line x1="78" y1="160" x2="78" y2="180" stroke="black" stroke-width="2"/>
            <line x1="78" y1="170" x2="140" y2="170" stroke="black" stroke-width="2"/>
            <text x="74" y="152" text-anchor="middle" id="schCin">Cin</text>
            <text x="30" y="174">In</text>
            
            <!-- Operating point display -->
            <text x="20" y="380" style="font-weight: bold;">Operating Point:</text>
            <text x="20" y="400" id="schVb">Vb = --</text>
            <text x="20" y="420" id="schVe">Ve = --</text>
            <text x="20" y="440" id="schVc">Vc = --</text>
            <text x="150" y="400" id="schIc">Ic = --</text>
            <text x="150" y="420" id="schSwing">Swing = --</text>
            
            <!-- Gain display -->
            <text x="20" y="475" style="font-weight: bold;">Gain:</text>
            <text x="20" y="495" id="schTransGain">Transistor: --</text>
            <text x="150" y="495" id="schLoadedGain">Loaded: --</text>
        </svg>

        <h2>Calculated Values</h2>
        <table>
            <tr><td>R1 (upper bias):</td><td id="r1"></td></tr>
            <tr><td>R2 (lower bias):</td><td id="r2"></td></tr>
            <tr><td>Rc (collector):</td><td id="rc"></td></tr>
            <tr><td>Re1 (unbypassed):</td><td id="re1"></td></tr>
            <tr><td>Re2 (bypassed):</td><td id="re2"></td></tr>
            <tr><td>Cin (input):</td><td id="cin"></td></tr>
            <tr><td>Cout (output):</td><td id="cout"></td></tr>
            <tr><td>Ce (bypass):</td><td id="ce"></td></tr>
        </table>

        <h2>Gain Breakdown</h2>
        <table>
            <tr><td>Input impedance (Zin):</td><td id="zin"></td></tr>
            <tr><td>Input attenuation:</td><td id="inputAtten"></td></tr>
            <tr><td>Transistor gain (Rc/Re1):</td><td id="transGain"></td></tr>
            <tr><td>Output attenuation:</td><td id="outputAtten"></td></tr>
            <tr><td><b>Loaded gain (total):</b></td><td id="loadedGain"></td></tr>
            <tr><td>Expected output:</td><td id="expectedOut"></td></tr>
        </table>

        <p id="note" style="color: gray;"></p>
    </div>

    <script src="../common.js"></script>
    <script>
        function calculate() {
            const vcc = parseFloat(document.getElementById('vcc').value);
            const targetGain = parseFloat(document.getElementById('gain').value);
            const vin = parseFloat(document.getElementById('vin').value) / 1000;
            const zsource = parseFloat(document.getElementById('zsource').value);
            const fLow = parseFloat(document.getElementById('fLow').value);
            const rload = parseFloat(document.getElementById('rload').value);
            const beta = parseFloat(document.getElementById('beta').value);

            const ve = Math.max(vcc * 0.1, 1.0);
            const vb = ve + 0.7;
            const vcMin = ve + 0.3;
            const vc = vcMin + (vcc - vcMin) / 2;
            const ic = 1e-3;

            const reTotal = ve / ic;
            const rc = (vcc - vc) / ic;
            const reIntrinsic = 0.026 / ic;
            
            // First pass: calculate bias resistors
            const ib = ic / beta;
            const idivider = ib * 10;
            const rtotal = vcc / idivider;
            const r2 = (vb / vcc) * rtotal;
            const r1 = rtotal - r2;

            // Now we need to solve for Re1 such that loaded gain = targetGain
            // 
            // Loaded gain = inputAtten * transistorGain * outputAtten
            // 
            // inputAtten = Zin / (Zin + Zsource)
            // where Zin = R1 || R2 || (beta * (Re1 + reIntrinsic))
            //
            // transistorGain = Rc / (Re1 + reIntrinsic)
            //
            // outputAtten = Rload / (Rload + Rc)
            //
            // This is complex because Re1 appears in both inputAtten and transistorGain
            // We'll solve iteratively

            const outputAtten = rload / (rload + rc);
            
            // Iteratively solve for Re1
            let re1 = rc / targetGain; // initial guess (ignoring loading)
            
            for (let i = 0; i < 20; i++) {
                const zinBase = beta * (re1 + reIntrinsic);
                const zin = parallel(r1, r2, zinBase);
                const inputAtten = zin / (zin + zsource);
                const transGain = rc / (re1 + reIntrinsic);
                const loadedGain = inputAtten * transGain * outputAtten;
                
                // Adjust Re1 based on error
                const error = targetGain / loadedGain;
                // If loadedGain is too low, we need higher transGain, so lower Re1
                re1 = re1 / Math.sqrt(error);
                
                // Clamp to valid range
                if (re1 < 0) re1 = 0;
                if (re1 > reTotal) re1 = reTotal;
            }

            let re2 = reTotal - re1;
            let notes = [];

            // Check limits
            if (re1 <= reIntrinsic) {
                re1 = 0;
                re2 = reTotal;
                const zinBase = beta * reIntrinsic;
                const zin = parallel(r1, r2, zinBase);
                const inputAtten = zin / (zin + zsource);
                const maxTransGain = rc / reIntrinsic;
                const maxLoadedGain = inputAtten * maxTransGain * outputAtten;
                notes.push('Max loaded gain is ' + maxLoadedGain.toFixed(1) + ' with full bypass.');
            }
            
            if (re1 >= reTotal) {
                re1 = reTotal;
                re2 = 0;
                notes.push('No bypass cap needed.');
            }

            // Round resistors to E24 values
            const r1Rounded = roundToE24(r1);
            const r2Rounded = roundToE24(r2);
            const rcRounded = roundToE24(rc);
            const re1Rounded = re1 > 0 ? roundToE24(re1) : 0;
            const re2Rounded = re2 > 0 ? roundToE24(re2) : 0;

            // Calculate final gains with ROUNDED values
            const zinBaseRounded = beta * (re1Rounded + reIntrinsic);
            const zinRounded = parallel(r1Rounded, r2Rounded, zinBaseRounded);
            const inputAttenRounded = zinRounded / (zinRounded + zsource);
            const outputAttenRounded = rload / (rload + rcRounded);
            const transGainRounded = rcRounded / (re1Rounded + reIntrinsic);
            const loadedGainRounded = inputAttenRounded * transGainRounded * outputAttenRounded;

            const voutPeak = vin * loadedGainRounded;

            // Capacitors - calculate then round
            const fcorner = fLow / 10;
            const cinCalc = 1 / (2 * Math.PI * fcorner * zinRounded);
            const coutCalc = 1 / (2 * Math.PI * fcorner * rload);
            const ceCalc = re2Rounded > 0 ? 10 / (2 * Math.PI * fLow * re2Rounded) : 0;

            const cinRounded = roundCap(cinCalc);
            const coutRounded = roundCap(coutCalc);
            const ceRounded = ceCalc > 0 ? roundCap(ceCalc) : 0;

            const swingUp = vcc - vc;
            const swingDown = vc - vcMin;
            const maxSwing = Math.min(swingUp, swingDown) * 2;

            // Warnings
            const warn = document.getElementById('warning');
            if (voutPeak * 2 > maxSwing) {
                warn.textContent = 'Warning: output (' + (voutPeak * 2).toFixed(2) + 'V p-p) exceeds swing (' + maxSwing.toFixed(2) + 'V p-p)';
                warn.style.display = 'block';
            } else {
                warn.style.display = 'none';
            }

            // Results
            document.getElementById('results').style.display = 'block';
            
            // Table values - show rounded values
            document.getElementById('r1').textContent = fmtLong(r1Rounded, 'Ω');
            document.getElementById('r2').textContent = fmtLong(r2Rounded, 'Ω');
            document.getElementById('rc').textContent = fmtLong(rcRounded, 'Ω');
            document.getElementById('re1').textContent = re1Rounded > 0 ? fmtLong(re1Rounded, 'Ω') : '0 (wire)';
            document.getElementById('re2').textContent = re2Rounded > 0 ? fmtLong(re2Rounded, 'Ω') : '0 (omit)';
            document.getElementById('cin').textContent = fmtLong(cinRounded, 'F');
            document.getElementById('cout').textContent = fmtLong(coutRounded, 'F');
            document.getElementById('ce').textContent = ceRounded > 0 ? fmtLong(ceRounded, 'F') : 'not needed';
            document.getElementById('note').textContent = notes.join(' ');
            
            // Gain breakdown - use rounded values
            document.getElementById('zin').textContent = fmtLong(zinRounded, 'Ω');
            document.getElementById('inputAtten').textContent = (inputAttenRounded * 100).toFixed(1) + '%';
            document.getElementById('transGain').textContent = transGainRounded.toFixed(1) + 'x';
            document.getElementById('outputAtten').textContent = (outputAttenRounded * 100).toFixed(1) + '%';
            document.getElementById('loadedGain').textContent = loadedGainRounded.toFixed(1) + 'x';
            document.getElementById('expectedOut').textContent = (voutPeak * 1000).toFixed(0) + ' mV peak';
            
            // Schematic values - show rounded
            document.getElementById('schR1').textContent = fmt(r1Rounded, 'Ω');
            document.getElementById('schR2').textContent = fmt(r2Rounded, 'Ω');
            document.getElementById('schRc').textContent = fmt(rcRounded, 'Ω');
            document.getElementById('schRe1').textContent = re1Rounded > 0 ? fmt(re1Rounded, 'Ω') : '0Ω';
            document.getElementById('schRe2').textContent = re2Rounded > 0 ? fmt(re2Rounded, 'Ω') : '0Ω';
            document.getElementById('schCin').textContent = fmt(cinRounded, 'F');
            document.getElementById('schCout').textContent = fmt(coutRounded, 'F');
            document.getElementById('schCe').textContent = ceRounded > 0 ? fmt(ceRounded, 'F') : '--';
            document.getElementById('schRload').textContent = fmt(rload, 'Ω');
            
            // Operating point
            document.getElementById('schVb').textContent = 'Vb = ' + fmt(vb, 'V');
            document.getElementById('schVe').textContent = 'Ve = ' + fmt(ve, 'V');
            document.getElementById('schVc').textContent = 'Vc = ' + fmt(vc, 'V');
            document.getElementById('schIc').textContent = 'Ic = ' + fmt(ic * 1000, 'mA');
            document.getElementById('schSwing').textContent = 'Swing = ' + fmt(maxSwing, 'V') + ' p-p';
            
            // Gains on schematic - use rounded calculations
            document.getElementById('schTransGain').textContent = 'Transistor: ' + transGainRounded.toFixed(1) + 'x';
            document.getElementById('schLoadedGain').textContent = 'Loaded: ' + loadedGainRounded.toFixed(1) + 'x';
        }
        window.onload = calculate;
    </script>
</body>
</html>
