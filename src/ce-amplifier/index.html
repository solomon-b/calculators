<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CE Amplifier Calculator</title>
</head>
<body>
    <h1>CE Amplifier Calculator</h1>

    <h2>Inputs</h2>
    <table>
        <tr>
            <td>Vcc:</td>
            <td><input type="number" id="vcc" value="10" step="0.1" min="1"> V</td>
        </tr>
        <tr>
            <td>Desired loaded gain:</td>
            <td><input type="number" id="gain" value="10" step="1" min="1"> V/V</td>
        </tr>
        <tr>
            <td>Input (peak):</td>
            <td><input type="number" id="vin" value="100" step="10" min="1"> mV</td>
        </tr>
        <tr>
            <td>Source impedance:</td>
            <td><input type="number" id="zsource" value="0" step="100" min="0"> Ω</td>
        </tr>
        <tr>
            <td>Low frequency:</td>
            <td><input type="number" id="fLow" value="20" step="1" min="1"> Hz</td>
        </tr>
        <tr>
            <td>Load:</td>
            <td><input type="number" id="rload" value="10000" step="1000" min="1000"> Ω</td>
        </tr>
        <tr>
            <td>β (hFE):</td>
            <td><input type="number" id="beta" value="100" step="10" min="20"></td>
        </tr>
    </table>
    <br>
    <button onclick="calculate()">Calculate</button>

    <div id="warning" style="color: red; display: none; margin-top: 10px;"></div>

    <div id="results">
        <h2>Schematic</h2>
        <div id="schematic"></div>

        <h2>Calculated Values</h2>
        <table>
            <tr><td>R1 (upper bias):</td><td id="r1"></td></tr>
            <tr><td>R2 (lower bias):</td><td id="r2"></td></tr>
            <tr><td>Rc (collector):</td><td id="rc"></td></tr>
            <tr><td>Re1 (unbypassed):</td><td id="re1"></td></tr>
            <tr><td>Re2 (bypassed):</td><td id="re2"></td></tr>
            <tr><td>Cin (input):</td><td id="cin"></td></tr>
            <tr><td>Cout (output):</td><td id="cout"></td></tr>
            <tr><td>Ce (bypass):</td><td id="ce"></td></tr>
        </table>

        <h2>Gain Breakdown</h2>
        <table>
            <tr><td>Input impedance (Zin):</td><td id="zin"></td></tr>
            <tr><td>Input attenuation:</td><td id="inputAtten"></td></tr>
            <tr><td>Transistor gain (Rc/Re1):</td><td id="transGain"></td></tr>
            <tr><td>Output attenuation:</td><td id="outputAtten"></td></tr>
            <tr><td><b>Loaded gain (total):</b></td><td id="loadedGain"></td></tr>
            <tr><td>Expected output:</td><td id="expectedOut"></td></tr>
        </table>

        <p id="note" style="color: gray;"></p>
    </div>

    <script src="../common.js"></script>
    <script src="../schematic.js"></script>
    <script>
        function drawSchematic(vals) {
            const sch = new Schematic(450, 450);

            // Transistor at center
            sch.place('npn', 'Q1', 200, 160);

            // Rc (collector resistor)
            sch.place('resistor-v', 'Rc', 225, 75, { label: vals.rc });

            // Re1 and Re2 (emitter resistors)
            sch.place('resistor-v', 'Re1', 225, 230, { label: vals.re1 });
            sch.place('resistor-v', 'Re2', 225, 305, { label: vals.re2, labelPos: 'left' });

            // Ce bypass cap
            sch.place('capacitor-v', 'Ce', 280, 290, { label: vals.ce });

            // Bias resistors
            sch.place('resistor-v', 'R1', 130, 80, { label: vals.r1 });
            sch.place('resistor-v', 'R2', 130, 195, { label: vals.r2 });

            // Cin input cap
            sch.place('capacitor-h', 'Cin', 70, 160, { label: vals.cin });

            // Cout output cap
            sch.place('capacitor-h', 'Cout', 290, 110, { label: vals.cout });

            // Load resistor (dashed - external)
            sch.place('resistor-v', 'Rload', 350, 165, { label: vals.rload, dashed: true });

            // Grounds
            sch.place('ground', 'GND1', 130, 240);
            sch.place('ground', 'GND2', 225, 350);
            sch.place('ground', 'GND3', 350, 210, { dashed: true });

            // --- Wiring ---

            // Vcc rail
            sch.label('Vcc', 225, 25, { anchor: 'middle' });
            sch.wire({ x: 225, y: 30 }, 'Rc.a');
            sch.wire({ x: 130, y: 30 }, { x: 225, y: 30 });
            sch.wire({ x: 130, y: 30 }, 'R1.a');

            // Rc to collector
            sch.wire('Rc.b', { x: 225, y: 110 });
            sch.node(225, 110);

            // Collector to output cap
            sch.wire({ x: 225, y: 110 }, { x: 225, y: 135 });
            sch.wire({ x: 225, y: 110 }, { x: 286, y: 110 });
            sch.wire('Cout.b', { x: 320, y: 110 });
            sch.wire({ x: 320, y: 110 }, { x: 350, y: 110 });
            sch.node(350, 110);
            sch.wire({ x: 350, y: 110 }, 'Rload.a', { dashed: true });
            sch.wire('Rload.b', 'GND3.a', { dashed: true });
            sch.label('Out', 360, 114);

            // Emitter wiring
            sch.wire('Q1.emitter', { x: 225, y: 195 });
            sch.wire({ x: 225, y: 195 }, 'Re1.a');
            sch.wire('Re1.b', { x: 225, y: 270 });
            sch.node(225, 270);
            sch.wire({ x: 225, y: 270 }, 'Re2.a');
            sch.wire('Re2.b', { x: 225, y: 340 });
            sch.node(225, 340);
            sch.wire({ x: 225, y: 340 }, 'GND2.a');

            // Ce bypass parallel to Re2
            sch.wire({ x: 225, y: 270 }, { x: 280, y: 270 });
            sch.wire({ x: 280, y: 270 }, 'Ce.a');
            sch.wire('Ce.b', { x: 280, y: 340 });
            sch.wire({ x: 280, y: 340 }, { x: 225, y: 340 });

            // Bias network
            sch.wire('R1.b', { x: 130, y: 160 });
            sch.node(130, 160);
            sch.wire({ x: 130, y: 160 }, 'R2.a');
            sch.wire('R2.b', 'GND1.a');

            // Base connection
            sch.wire({ x: 130, y: 160 }, 'Cin.b');
            sch.wire('Cin.a', { x: 40, y: 160 });
            sch.label('In', 25, 164);
            sch.wire({ x: 130, y: 160 }, 'Q1.base');

            // Info display
            sch.label('Operating Point:', 20, 370, { bold: true });
            sch.label('Vb = ' + vals.vb, 20, 390);
            sch.label('Ve = ' + vals.ve, 20, 410);
            sch.label('Vc = ' + vals.vc, 20, 430);
            sch.label('Ic = ' + vals.ic, 150, 390);
            sch.label('Swing = ' + vals.swing, 150, 410);

            sch.label('Gain:', 280, 370, { bold: true });
            sch.label('Trans: ' + vals.transGain, 280, 390);
            sch.label('Loaded: ' + vals.loadedGain, 280, 410);

            return sch.toSVG();
        }

        function calculate() {
            const vcc = parseFloat(document.getElementById('vcc').value);
            const targetGain = parseFloat(document.getElementById('gain').value);
            const vin = parseFloat(document.getElementById('vin').value) / 1000;
            const zsource = parseFloat(document.getElementById('zsource').value);
            const fLow = parseFloat(document.getElementById('fLow').value);
            const rload = parseFloat(document.getElementById('rload').value);
            const beta = parseFloat(document.getElementById('beta').value);

            const ve = Math.max(vcc * 0.1, 1.0);
            const vb = ve + 0.7;
            const vcMin = ve + 0.3;
            const vc = vcMin + (vcc - vcMin) / 2;
            const ic = 1e-3;

            const reTotal = ve / ic;
            const rc = (vcc - vc) / ic;
            const reIntrinsic = 0.026 / ic;
            
            // First pass: calculate bias resistors
            const ib = ic / beta;
            const idivider = ib * 10;
            const rtotal = vcc / idivider;
            const r2 = (vb / vcc) * rtotal;
            const r1 = rtotal - r2;

            // Now we need to solve for Re1 such that loaded gain = targetGain
            // 
            // Loaded gain = inputAtten * transistorGain * outputAtten
            // 
            // inputAtten = Zin / (Zin + Zsource)
            // where Zin = R1 || R2 || (beta * (Re1 + reIntrinsic))
            //
            // transistorGain = Rc / (Re1 + reIntrinsic)
            //
            // outputAtten = Rload / (Rload + Rc)
            //
            // This is complex because Re1 appears in both inputAtten and transistorGain
            // We'll solve iteratively

            const outputAtten = rload / (rload + rc);
            
            // Iteratively solve for Re1
            let re1 = rc / targetGain; // initial guess (ignoring loading)
            
            for (let i = 0; i < 20; i++) {
                const zinBase = beta * (re1 + reIntrinsic);
                const zin = parallel(r1, r2, zinBase);
                const inputAtten = zin / (zin + zsource);
                const transGain = rc / (re1 + reIntrinsic);
                const loadedGain = inputAtten * transGain * outputAtten;
                
                // Adjust Re1 based on error
                const error = targetGain / loadedGain;
                // If loadedGain is too low, we need higher transGain, so lower Re1
                re1 = re1 / Math.sqrt(error);
                
                // Clamp to valid range
                if (re1 < 0) re1 = 0;
                if (re1 > reTotal) re1 = reTotal;
            }

            let re2 = reTotal - re1;
            let notes = [];

            // Check limits
            if (re1 <= reIntrinsic) {
                re1 = 0;
                re2 = reTotal;
                const zinBase = beta * reIntrinsic;
                const zin = parallel(r1, r2, zinBase);
                const inputAtten = zin / (zin + zsource);
                const maxTransGain = rc / reIntrinsic;
                const maxLoadedGain = inputAtten * maxTransGain * outputAtten;
                notes.push('Max loaded gain is ' + maxLoadedGain.toFixed(1) + ' with full bypass.');
            }
            
            if (re1 >= reTotal) {
                re1 = reTotal;
                re2 = 0;
                notes.push('No bypass cap needed.');
            }

            // Round resistors to E24 values
            const r1Rounded = roundToE24(r1);
            const r2Rounded = roundToE24(r2);
            const rcRounded = roundToE24(rc);
            const re1Rounded = re1 > 0 ? roundToE24(re1) : 0;
            const re2Rounded = re2 > 0 ? roundToE24(re2) : 0;

            // Calculate final gains with ROUNDED values
            const zinBaseRounded = beta * (re1Rounded + reIntrinsic);
            const zinRounded = parallel(r1Rounded, r2Rounded, zinBaseRounded);
            const inputAttenRounded = zinRounded / (zinRounded + zsource);
            const outputAttenRounded = rload / (rload + rcRounded);
            const transGainRounded = rcRounded / (re1Rounded + reIntrinsic);
            const loadedGainRounded = inputAttenRounded * transGainRounded * outputAttenRounded;

            const voutPeak = vin * loadedGainRounded;

            // Capacitors - calculate then round
            const fcorner = fLow / 10;
            const cinCalc = 1 / (2 * Math.PI * fcorner * zinRounded);
            const coutCalc = 1 / (2 * Math.PI * fcorner * rload);
            const ceCalc = re2Rounded > 0 ? 10 / (2 * Math.PI * fLow * re2Rounded) : 0;

            const cinRounded = roundCap(cinCalc);
            const coutRounded = roundCap(coutCalc);
            const ceRounded = ceCalc > 0 ? roundCap(ceCalc) : 0;

            const swingUp = vcc - vc;
            const swingDown = vc - vcMin;
            const maxSwing = Math.min(swingUp, swingDown) * 2;

            // Warnings
            const warn = document.getElementById('warning');
            if (voutPeak * 2 > maxSwing) {
                warn.textContent = 'Warning: output (' + (voutPeak * 2).toFixed(2) + 'V p-p) exceeds swing (' + maxSwing.toFixed(2) + 'V p-p)';
                warn.style.display = 'block';
            } else {
                warn.style.display = 'none';
            }

            // Results
            document.getElementById('results').style.display = 'block';

            // Draw schematic
            document.getElementById('schematic').innerHTML = drawSchematic({
                r1: fmt(r1Rounded, 'Ω'),
                r2: fmt(r2Rounded, 'Ω'),
                rc: fmt(rcRounded, 'Ω'),
                re1: re1Rounded > 0 ? fmt(re1Rounded, 'Ω') : '0Ω',
                re2: re2Rounded > 0 ? fmt(re2Rounded, 'Ω') : '0Ω',
                cin: fmt(cinRounded, 'F'),
                cout: fmt(coutRounded, 'F'),
                ce: ceRounded > 0 ? fmt(ceRounded, 'F') : '--',
                rload: fmt(rload, 'Ω'),
                vb: fmt(vb, 'V'),
                ve: fmt(ve, 'V'),
                vc: fmt(vc, 'V'),
                ic: fmt(ic * 1000, 'mA'),
                swing: fmt(maxSwing, 'V') + ' p-p',
                transGain: transGainRounded.toFixed(1) + 'x',
                loadedGain: loadedGainRounded.toFixed(1) + 'x'
            });

            // Table values - show rounded values
            document.getElementById('r1').textContent = fmtLong(r1Rounded, 'Ω');
            document.getElementById('r2').textContent = fmtLong(r2Rounded, 'Ω');
            document.getElementById('rc').textContent = fmtLong(rcRounded, 'Ω');
            document.getElementById('re1').textContent = re1Rounded > 0 ? fmtLong(re1Rounded, 'Ω') : '0 (wire)';
            document.getElementById('re2').textContent = re2Rounded > 0 ? fmtLong(re2Rounded, 'Ω') : '0 (omit)';
            document.getElementById('cin').textContent = fmtLong(cinRounded, 'F');
            document.getElementById('cout').textContent = fmtLong(coutRounded, 'F');
            document.getElementById('ce').textContent = ceRounded > 0 ? fmtLong(ceRounded, 'F') : 'not needed';
            document.getElementById('note').textContent = notes.join(' ');

            // Gain breakdown - use rounded values
            document.getElementById('zin').textContent = fmtLong(zinRounded, 'Ω');
            document.getElementById('inputAtten').textContent = (inputAttenRounded * 100).toFixed(1) + '%';
            document.getElementById('transGain').textContent = transGainRounded.toFixed(1) + 'x';
            document.getElementById('outputAtten').textContent = (outputAttenRounded * 100).toFixed(1) + '%';
            document.getElementById('loadedGain').textContent = loadedGainRounded.toFixed(1) + 'x';
            document.getElementById('expectedOut').textContent = (voutPeak * 1000).toFixed(0) + ' mV peak';
        }
        window.onload = calculate;
    </script>
</body>
</html>
