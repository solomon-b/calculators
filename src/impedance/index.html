<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impedance Matching - The Hidden Voltage Divider</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 { color: #333; }
        h2 { color: #555; margin-top: 2em; }
        .concept-box {
            background: #f0f7ff;
            border-left: 4px solid #2266cc;
            padding: 15px 20px;
            margin: 20px 0;
        }
        .warning-box {
            background: #fff8f0;
            border-left: 4px solid #cc6622;
            padding: 15px 20px;
            margin: 20px 0;
        }
        .calculator {
            background: #fafafa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .calculator input[type="number"] {
            width: 100px;
            padding: 5px;
            font-size: 14px;
        }
        .calculator select {
            padding: 5px;
            font-size: 14px;
        }
        .results {
            margin-top: 20px;
            padding: 15px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .results table {
            width: 100%;
            border-collapse: collapse;
        }
        .results td {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .results td:last-child {
            text-align: right;
            font-family: monospace;
            font-weight: bold;
        }
        .good { color: #2a2; }
        .okay { color: #a80; }
        .bad { color: #c22; }
        .presets {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
        }
        .preset-btn {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: #fff;
            cursor: pointer;
            font-size: 13px;
        }
        .preset-btn:hover {
            background: #f0f0f0;
            border-color: #999;
        }
        .preset-btn.active {
            background: #2266cc;
            color: white;
            border-color: #2266cc;
        }
        .diagram {
            text-align: center;
            margin: 20px 0;
        }
        .formula {
            font-family: serif;
            font-size: 1.2em;
            text-align: center;
            padding: 15px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 15px 0;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.95em;
        }
    </style>
</head>
<body>
    <h1>Impedance Matching</h1>
    <p style="font-size: 1.1em; color: #555;">
        Every connection between a source and load is secretly a voltage divider.
        Understanding this explains most "mysterious" signal loss in electronics.
    </p>

    <h2>The Hidden Voltage Divider</h2>

    <div class="concept-box">
        <p><strong>Key insight:</strong> Every signal source has an output impedance (Z<sub>source</sub>).
        When you connect a load (Z<sub>load</sub>), they form a voltage divider:</p>
    </div>

    <div class="diagram" id="dividerDiagram"></div>

    <div class="formula">
        V<sub>load</sub> = V<sub>source</sub> × <sup>Z<sub>load</sub></sup>&frasl;<sub>(Z<sub>source</sub> + Z<sub>load</sub>)</sub>
    </div>

    <p>This means:</p>
    <ul>
        <li><strong>Z<sub>load</sub> >> Z<sub>source</sub></strong> → Most voltage reaches the load (voltage transfer)</li>
        <li><strong>Z<sub>load</sub> = Z<sub>source</sub></strong> → Maximum power transfer (but only 50% voltage)</li>
        <li><strong>Z<sub>load</sub> << Z<sub>source</sub></strong> → Most voltage dropped across source (signal loss!)</li>
    </ul>

    <h2>Calculator</h2>

    <div class="calculator">
        <h3 style="margin-top: 0;">Common Scenarios</h3>
        <div class="presets" id="presets"></div>

        <h3>Parameters</h3>
        <table style="border-collapse: collapse;">
            <tr>
                <td style="padding: 8px 15px 8px 0;">Source impedance:</td>
                <td>
                    <input type="number" id="zsource" value="1000" min="0" step="100">
                    <select id="zsourceUnit">
                        <option value="1">Ω</option>
                        <option value="1000" selected>kΩ</option>
                        <option value="1000000">MΩ</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td style="padding: 8px 15px 8px 0;">Load impedance:</td>
                <td>
                    <input type="number" id="zload" value="10" min="0" step="100">
                    <select id="zloadUnit">
                        <option value="1">Ω</option>
                        <option value="1000" selected>kΩ</option>
                        <option value="1000000">MΩ</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td style="padding: 8px 15px 8px 0;">Source voltage (optional):</td>
                <td>
                    <input type="number" id="vsource" value="1" min="0" step="0.1"> V (peak)
                </td>
            </tr>
        </table>

        <button onclick="calculate()" style="margin-top: 15px; padding: 10px 20px; font-size: 14px;">Calculate</button>

        <div class="results" id="results"></div>
    </div>

    <h2>Rules of Thumb</h2>

    <div class="concept-box">
        <p><strong>The 10:1 Rule:</strong> For minimal signal loss (&lt;10%), keep Z<sub>load</sub> at least 10× larger than Z<sub>source</sub>.</p>
        <p style="margin-bottom: 0;">This gives you 91% voltage transfer — usually "good enough" for most applications.</p>
    </div>

    <h3>When to Use Each Strategy</h3>
    <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
        <tr style="background: #f5f5f5;">
            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Goal</th>
            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Strategy</th>
            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Examples</th>
        </tr>
        <tr>
            <td style="padding: 10px; border-bottom: 1px solid #eee;"><strong>Maximum voltage</strong></td>
            <td style="padding: 10px; border-bottom: 1px solid #eee;">Z<sub>load</sub> >> Z<sub>source</sub></td>
            <td style="padding: 10px; border-bottom: 1px solid #eee;">Audio preamps, instrument inputs, sensor buffers</td>
        </tr>
        <tr>
            <td style="padding: 10px; border-bottom: 1px solid #eee;"><strong>Maximum power</strong></td>
            <td style="padding: 10px; border-bottom: 1px solid #eee;">Z<sub>load</sub> = Z<sub>source</sub></td>
            <td style="padding: 10px; border-bottom: 1px solid #eee;">RF systems, transmission lines, antenna matching</td>
        </tr>
        <tr>
            <td style="padding: 10px; border-bottom: 1px solid #eee;"><strong>Controlled impedance</strong></td>
            <td style="padding: 10px; border-bottom: 1px solid #eee;">Z<sub>load</sub> = Z<sub>line</sub> = Z<sub>source</sub></td>
            <td style="padding: 10px; border-bottom: 1px solid #eee;">Video cables (75Ω), Ethernet, high-speed digital</td>
        </tr>
    </table>

    <div class="warning-box">
        <p><strong>Common mistake:</strong> Assuming "impedance matching" always means Z<sub>load</sub> = Z<sub>source</sub>.</p>
        <p style="margin-bottom: 0;">In audio and most analog circuits, you actually want Z<sub>load</sub> >> Z<sub>source</sub> to preserve signal voltage.
        True "matching" (equal impedances) is mainly for RF and transmission lines where reflections matter.</p>
    </div>

    <h2>Why This Matters</h2>
    <p>Understanding the voltage divider model explains many real-world issues:</p>
    <ul>
        <li><strong>Guitar sounds thin when plugged into wrong input</strong> — High-Z pickup into low-Z input = massive signal loss</li>
        <li><strong>Headphones sound different on different sources</strong> — Source impedance affects frequency response</li>
        <li><strong>Oscilloscope loads down circuit</strong> — 1MΩ probe still forms divider with high-Z nodes</li>
        <li><strong>Buffer amplifiers exist</strong> — Convert high-Z to low-Z without signal loss</li>
    </ul>

    <script src="../common.js"></script>
    <script>
        // Preset configurations: [name, zsource, zsourceUnit, zload, zloadUnit, description]
        const presets = [
            ['Guitar → Amp', 10, 'kΩ', 1, 'MΩ', 'Passive pickup into amp input'],
            ['Guitar → Pedal', 10, 'kΩ', 500, 'kΩ', 'Pickup into typical pedal input'],
            ['Guitar → DI Box', 10, 'kΩ', 10, 'kΩ', 'Pickup into low-Z DI (bad match!)'],
            ['Mic → Preamp', 150, 'Ω', 1.5, 'kΩ', 'Dynamic mic into preamp'],
            ['Phone → Earbuds', 100, 'Ω', 32, 'Ω', 'Phone output into 32Ω earbuds - poor match'],
            ['Phone → Headphones', 100, 'Ω', 300, 'Ω', 'Phone output into 300Ω over-ear headphones'],
            ['HP Amp → Earbuds', 1, 'Ω', 32, 'Ω', 'Good headphone amp into 32Ω earbuds'],
            ['HP Amp → Headphones', 1, 'Ω', 300, 'Ω', 'Good headphone amp into 300Ω headphones'],
            ['Tube HP Amp → Headphones', 120, 'Ω', 300, 'Ω', 'Tube headphone amp into 300Ω (good pairing)'],
            ['Tube HP Amp → Earbuds', 120, 'Ω', 32, 'Ω', 'Tube amp into 32Ω earbuds (poor match!)'],
            ['Op-amp → Load', 100, 'Ω', 10, 'kΩ', 'Typical op-amp driving load'],
            ['DAC → Amp', 100, 'Ω', 10, 'kΩ', 'DAC line output to amplifier'],
            ['Piezo → Buffer', 1, 'MΩ', 10, 'MΩ', 'Piezo pickup into JFET buffer'],
            ['Piezo → Amp (bad)', 1, 'MΩ', 1, 'MΩ', 'Piezo direct into amp (loses bass)'],
            ['RF 50Ω Match', 50, 'Ω', 50, 'Ω', 'Matched RF system'],
            ['Video 75Ω', 75, 'Ω', 75, 'Ω', 'Terminated video cable'],
            ['Scope Probe 10x', 10, 'MΩ', 10, 'MΩ', '10x probe on high-Z node'],
            ['Emitter Follower', 1, 'kΩ', 5, 'kΩ', 'EF buffer output to load'],
        ];

        function initPresets() {
            const container = document.getElementById('presets');
            presets.forEach((p, i) => {
                const btn = document.createElement('button');
                btn.className = 'preset-btn';
                btn.textContent = p[0];
                btn.title = p[5];
                btn.onclick = () => applyPreset(i);
                container.appendChild(btn);
            });
        }

        function applyPreset(index) {
            const p = presets[index];
            document.getElementById('zsource').value = p[1];
            document.getElementById('zsourceUnit').value = unitToValue(p[2]);
            document.getElementById('zload').value = p[3];
            document.getElementById('zloadUnit').value = unitToValue(p[4]);

            // Update active button
            document.querySelectorAll('.preset-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });

            calculate();
        }

        function unitToValue(unit) {
            if (unit === 'Ω') return '1';
            if (unit === 'kΩ') return '1000';
            if (unit === 'MΩ') return '1000000';
            return '1';
        }

        function formatZ(z) {
            if (z >= 1e6) return (z / 1e6).toFixed(z % 1e6 === 0 ? 0 : 1) + ' MΩ';
            if (z >= 1e3) return (z / 1e3).toFixed(z % 1e3 === 0 ? 0 : 1) + ' kΩ';
            return z.toFixed(z === Math.floor(z) ? 0 : 1) + ' Ω';
        }

        function drawDiagram(zsource, zload, vSource, vLoad, ratio) {
            const width = 500;
            const height = 200;

            // Voltage bar heights
            const maxBarH = 100;
            const sourceBarH = maxBarH;
            const loadBarH = maxBarH * ratio;
            const lossBarH = maxBarH - loadBarH;

            let svg = `<svg width="${width}" height="${height}" style="font-family: system-ui, sans-serif; font-size: 12px;">`;

            // Source (battery/generator symbol)
            svg += `<circle cx="60" cy="100" r="20" fill="none" stroke="#333" stroke-width="2"/>`;
            svg += `<line x1="60" y1="80" x2="60" y2="85" stroke="#333" stroke-width="2"/>`;
            svg += `<line x1="55" y1="115" x2="65" y2="115" stroke="#333" stroke-width="2"/>`;
            svg += `<line x1="57" y1="120" x2="63" y2="120" stroke="#333" stroke-width="2"/>`;
            svg += `<text x="60" y="145" text-anchor="middle" fill="#666">V<tspan font-size="9" dy="2">source</tspan></text>`;

            // Zsource resistor
            svg += `<line x1="60" y1="80" x2="60" y2="50" stroke="#333" stroke-width="2"/>`;
            svg += `<line x1="60" y1="50" x2="120" y2="50" stroke="#333" stroke-width="2"/>`;

            // Resistor symbol for Zsource (Euro style - rectangle)
            svg += `<line x1="120" y1="50" x2="130" y2="50" stroke="#c44" stroke-width="2"/>`;
            svg += `<rect x="130" y="42" width="50" height="16" fill="none" stroke="#c44" stroke-width="2"/>`;
            svg += `<line x1="180" y1="50" x2="190" y2="50" stroke="#c44" stroke-width="2"/>`;
            svg += `<text x="155" y="35" text-anchor="middle" fill="#c44" font-weight="bold">Z<tspan font-size="9" dy="2">source</tspan></text>`;
            svg += `<text x="155" y="75" text-anchor="middle" fill="#c44" font-size="11">${formatZ(zsource)}</text>`;

            // Connection to load
            svg += `<line x1="190" y1="50" x2="260" y2="50" stroke="#333" stroke-width="2"/>`;

            // Node dot
            svg += `<circle cx="260" cy="50" r="4" fill="#333"/>`;
            svg += `<text x="260" y="35" text-anchor="middle" fill="#666" font-size="11">V<tspan font-size="8" dy="1">load</tspan></text>`;

            // Zload resistor (vertical, Euro style - rectangle)
            svg += `<line x1="260" y1="50" x2="260" y2="70" stroke="#333" stroke-width="2"/>`;
            svg += `<rect x="252" y="70" width="16" height="50" fill="none" stroke="#2a2" stroke-width="2"/>`;
            svg += `<line x1="260" y1="120" x2="260" y2="130" stroke="#2a2" stroke-width="2"/>`;
            svg += `<text x="290" y="100" fill="#2a2" font-weight="bold">Z<tspan font-size="9" dy="2">load</tspan></text>`;
            svg += `<text x="290" y="115" fill="#2a2" font-size="11">${formatZ(zload)}</text>`;

            // Ground connections
            svg += `<line x1="260" y1="130" x2="260" y2="150" stroke="#333" stroke-width="2"/>`;
            svg += `<line x1="60" y1="120" x2="60" y2="150" stroke="#333" stroke-width="2"/>`;
            svg += `<line x1="60" y1="150" x2="260" y2="150" stroke="#333" stroke-width="2"/>`;

            // Ground symbol
            svg += `<line x1="150" y1="150" x2="170" y2="150" stroke="#333" stroke-width="2"/>`;
            svg += `<line x1="155" y1="155" x2="165" y2="155" stroke="#333" stroke-width="2"/>`;
            svg += `<line x1="158" y1="160" x2="162" y2="160" stroke="#333" stroke-width="2"/>`;

            // Voltage bars
            const barX = 380;
            const barW = 40;
            const barY = 40;

            // Full source voltage bar
            svg += `<rect x="${barX}" y="${barY + maxBarH - sourceBarH}" width="${barW}" height="${sourceBarH}" fill="#ddd" stroke="#999"/>`;
            svg += `<text x="${barX + barW/2}" y="${barY + maxBarH + 15}" text-anchor="middle" font-size="11">V<tspan font-size="8" dy="1">src</tspan></text>`;

            // Load gets this much
            svg += `<rect x="${barX + 60}" y="${barY + maxBarH - loadBarH}" width="${barW}" height="${loadBarH}" fill="#afa" stroke="#2a2"/>`;

            // Loss shown on top
            if (lossBarH > 2) {
                svg += `<rect x="${barX + 60}" y="${barY + maxBarH - sourceBarH}" width="${barW}" height="${lossBarH}" fill="#fcc" stroke="#c44"/>`;
                if (lossBarH > 15) {
                    svg += `<text x="${barX + 60 + barW/2}" y="${barY + maxBarH - sourceBarH + lossBarH/2 + 4}" text-anchor="middle" font-size="10" fill="#922">loss</text>`;
                }
            }
            svg += `<text x="${barX + 60 + barW/2}" y="${barY + maxBarH + 15}" text-anchor="middle" font-size="11">V<tspan font-size="8" dy="1">load</tspan></text>`;

            // Percentage
            svg += `<text x="${barX + 30 + barW}" y="${barY - 5}" text-anchor="middle" font-size="14" font-weight="bold" fill="${ratio > 0.9 ? '#2a2' : ratio > 0.7 ? '#a80' : '#c22'}">${(ratio * 100).toFixed(1)}%</text>`;

            svg += '</svg>';
            return svg;
        }

        function calculate() {
            const zsourceVal = parseFloat(document.getElementById('zsource').value);
            const zsourceUnit = parseFloat(document.getElementById('zsourceUnit').value);
            const zloadVal = parseFloat(document.getElementById('zload').value);
            const zloadUnit = parseFloat(document.getElementById('zloadUnit').value);
            const vSource = parseFloat(document.getElementById('vsource').value) || 1;

            const zsource = zsourceVal * zsourceUnit;
            const zload = zloadVal * zloadUnit;

            // Calculations
            const ratio = zload / (zsource + zload);
            const vLoad = vSource * ratio;
            const current = vSource / (zsource + zload);
            const powerLoad = (vLoad * vLoad) / zload;

            // Max power transfer (when matched)
            const maxPower = (vSource * vSource) / (4 * zsource);
            const powerRatio = powerLoad / maxPower;

            // Impedance ratio
            const zRatio = zload / zsource;

            // Rating
            let rating, ratingClass;
            if (ratio >= 0.9) {
                rating = 'Excellent voltage transfer';
                ratingClass = 'good';
            } else if (ratio >= 0.7) {
                rating = 'Acceptable for most applications';
                ratingClass = 'okay';
            } else if (ratio >= 0.5) {
                rating = 'Significant signal loss';
                ratingClass = 'okay';
            } else {
                rating = 'Poor match - severe signal loss!';
                ratingClass = 'bad';
            }

            // Update diagram
            document.getElementById('dividerDiagram').innerHTML = drawDiagram(zsource, zload, vSource, vLoad, ratio);

            // Build results
            let html = `
                <h4 style="margin: 0 0 10px 0; color: #555;">Voltage Transfer</h4>
                <table>
                    <tr>
                        <td>Impedance ratio (Z<sub>load</sub>/Z<sub>source</sub>)</td>
                        <td>${zRatio.toFixed(2)}:1</td>
                    </tr>
                    <tr>
                        <td>Voltage transfer</td>
                        <td class="${ratingClass}" style="font-size: 1.2em;">${(ratio * 100).toFixed(1)}%</td>
                    </tr>
                    <tr>
                        <td>Voltage at load</td>
                        <td>${(vLoad * 1000).toFixed(1)} mV (from ${(vSource * 1000).toFixed(0)} mV source)</td>
                    </tr>
                    <tr>
                        <td>Signal loss</td>
                        <td class="${ratingClass}">${(20 * Math.log10(ratio)).toFixed(2)} dB</td>
                    </tr>
                </table>
                <p style="margin: 15px 0 5px 0;"><strong class="${ratingClass}">${rating}</strong></p>

                <h4 style="margin: 20px 0 10px 0; padding-top: 15px; border-top: 1px solid #ddd; color: #555;">Power Transfer</h4>
                <table>
                    <tr>
                        <td>Current</td>
                        <td>${current >= 0.001 ? (current * 1000).toFixed(3) + ' mA' : (current * 1e6).toFixed(3) + ' µA'}</td>
                    </tr>
                    <tr>
                        <td>Power to load</td>
                        <td>${powerLoad >= 0.001 ? (powerLoad * 1000).toFixed(3) + ' mW' : (powerLoad * 1e6).toFixed(3) + ' µW'}</td>
                    </tr>
                    <tr>
                        <td>Power vs. matched (Z<sub>load</sub>=Z<sub>source</sub>)</td>
                        <td>${(powerRatio * 100).toFixed(1)}% of maximum</td>
                    </tr>
                </table>
            `;

            // Add recommendation
            if (ratio < 0.9) {
                html += `<p style="color: #666; font-size: 0.9em; margin-top: 10px;">`;
                if (zRatio < 10) {
                    const neededZload = zsource * 10;
                    html += `<strong>Tip:</strong> For >90% voltage transfer, Z<sub>load</sub> should be at least ${formatZ(neededZload)}.`;
                    if (zsource > 10000) {
                        html += ` Consider adding a buffer amplifier to lower the effective source impedance.`;
                    }
                }
                html += `</p>`;
            }

            document.getElementById('results').innerHTML = html;
        }

        // Initialize
        initPresets();
        calculate();
    </script>
</body>
</html>
