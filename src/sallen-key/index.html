<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sallen-Key Filter Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    primary: '#2266cc',
                }
            }
        }
    }
    </script>
    <style>
        svg text { font-family: ui-monospace, monospace; }
    </style>
</head>
<body class="max-w-3xl mx-auto px-4 sm:px-6 py-8 font-sans leading-relaxed">
    <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-4">Sallen-Key Filter Calculator</h1>
    <p class="text-gray-600 text-lg max-w-xl mb-6">
        Design an active Sallen-Key filter using op-amps. Supports lowpass and highpass
        configurations with Butterworth, Bessel, or Chebyshev responses.
    </p>

    <h2 class="text-xl font-semibold text-gray-600 mt-8 mb-4">Inputs</h2>
    <div class="overflow-x-auto">
        <table class="w-full sm:w-auto">
            <tr>
                <td class="py-2 pr-4">Filter type:</td>
                <td class="py-2">
                    <select id="filterType" class="px-2 py-1 border border-gray-300 rounded text-sm">
                        <option value="lowpass">Lowpass</option>
                        <option value="highpass">Highpass</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td class="py-2 pr-4">Response:</td>
                <td class="py-2">
                    <select id="responseType" onchange="updateRippleVisibility()" class="px-2 py-1 border border-gray-300 rounded text-sm">
                        <option value="butterworth">Butterworth (maximally flat)</option>
                        <option value="chebyshev">Chebyshev Type I (steeper rolloff)</option>
                    </select>
                </td>
            </tr>
            <tr id="rippleRow" style="display: none;">
                <td class="py-2 pr-4">Passband ripple:</td>
                <td class="py-2">
                    <select id="ripple" class="px-2 py-1 border border-gray-300 rounded text-sm">
                        <option value="0.5">0.5 dB</option>
                        <option value="1" selected>1 dB</option>
                        <option value="2">2 dB</option>
                        <option value="3">3 dB</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td class="py-2 pr-4">Order:</td>
                <td class="py-2">
                    <select id="order" class="px-2 py-1 border border-gray-300 rounded text-sm">
                        <option value="2">2nd order (-12 dB/oct)</option>
                        <option value="4">4th order (-24 dB/oct)</option>
                        <option value="6">6th order (-36 dB/oct)</option>
                        <option value="8">8th order (-48 dB/oct)</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td class="py-2 pr-4">Cutoff frequency:</td>
                <td class="py-2"><input type="number" id="fc" value="1000" step="100" min="1" class="w-20 px-2 py-1 border border-gray-300 rounded text-sm"> Hz</td>
            </tr>
            <tr>
                <td class="py-2 pr-4">Capacitor value:</td>
                <td class="py-2"><input type="number" id="cval" value="10" step="1" min="1" class="w-20 px-2 py-1 border border-gray-300 rounded text-sm"> nF</td>
            </tr>
            <tr>
                <td class="py-2 pr-4">Supply voltage (+/-):</td>
                <td class="py-2"><input type="number" id="vcc" value="12" step="1" min="5" class="w-20 px-2 py-1 border border-gray-300 rounded text-sm"> V</td>
            </tr>
        </table>
    </div>

    <div class="flex flex-wrap gap-2 mt-4">
        <button onclick="calculate()" class="px-5 py-2 bg-primary text-white rounded hover:bg-blue-700 cursor-pointer text-sm">Calculate</button>
        <button onclick="resetDefaults()" class="px-5 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 cursor-pointer text-sm">Reset</button>
    </div>

    <div id="warning" class="hidden text-red-700 bg-red-50 border-l-4 border-red-600 p-4 my-4"></div>

    <div id="results">
        <h2 class="text-xl font-semibold text-gray-600 mt-8 mb-4">Filter Summary</h2>
        <div class="overflow-x-auto">
            <table class="w-full sm:w-auto">
                <tr><td class="py-2 pr-4">Type:</td><td id="summaryType" class="py-2 font-mono"></td></tr>
                <tr><td class="py-2 pr-4">Order:</td><td id="summaryOrder" class="py-2 font-mono"></td></tr>
                <tr><td class="py-2 pr-4">Cutoff frequency:</td><td id="summaryFc" class="py-2 font-mono"></td></tr>
                <tr><td class="py-2 pr-4">Rolloff:</td><td id="summaryRolloff" class="py-2 font-mono"></td></tr>
                <tr><td class="py-2 pr-4">Total gain:</td><td id="summaryGain" class="py-2 font-mono"></td></tr>
            </table>
        </div>

        <h2 class="text-xl font-semibold text-gray-600 mt-8 mb-4">Stages</h2>
        <div id="stages"></div>

        <h2 class="text-xl font-semibold text-gray-600 mt-8 mb-4">Frequency Response</h2>
        <div id="response" class="my-2.5"></div>
    </div>

    <script src="../common.js"></script>
    <script src="../schematic.js"></script>
    <script src="../graph.js"></script>
    <script>
        // Draw a single stage into an existing schematic at x offset
        function drawStageAt(sch, stage, vcc, xOff, stageIdx, isFirst, isLast) {
            const isLowpass = stage.type === 'lowpass';
            const Rval = fmt(stage.R, 'Ω');
            const Cval = fmt(stage.C, 'F');
            const prefix = 'S' + stageIdx + '_';

            // Signal path at y=70, feedback at y=25
            const sigY = 70;
            const fbY = 25;

            // Op-amp at local x=330
            sch.place('opamp', prefix + 'U', xOff + 330, 90, { flip: true });

            // Z1, Z2: Series elements from input to + input
            if (isLowpass) {
                sch.place('resistor-h', prefix + 'Z1', xOff + 50, sigY, { label: Rval });
                sch.place('resistor-h', prefix + 'Z2', xOff + 140, sigY, { label: Rval });
            } else {
                sch.place('capacitor-h', prefix + 'Z1', xOff + 50, sigY, { label: Cval });
                sch.place('capacitor-h', prefix + 'Z2', xOff + 140, sigY, { label: Cval });
            }

            // Z3: Feedback from Vx to output
            if (isLowpass) {
                sch.place('capacitor-h', prefix + 'Z3', xOff + 240, fbY, { label: Cval });
            } else {
                sch.place('resistor-h', prefix + 'Z3', xOff + 240, fbY, { label: Rval });
            }

            // Z4: Shunt from V+ node to ground
            if (isLowpass) {
                sch.place('capacitor-v', prefix + 'Z4', xOff + 210, 120, { label: Cval });
                sch.place('ground', prefix + 'GND1', xOff + 210, 145);
            } else {
                sch.place('resistor-v', prefix + 'Z4', xOff + 210, 140, { label: Rval });
                sch.place('ground', prefix + 'GND1', xOff + 210, 185);
            }

            // Gain network
            sch.place('resistor-v', prefix + 'Ra', xOff + 260, 230, { label: fmt(stage.Ra, 'Ω') });
            sch.place('ground', prefix + 'GND2', xOff + 260, 275);
            if (stage.Rb > 0) {
                sch.place('resistor-h', prefix + 'Rb', xOff + 340, 195, { label: fmt(stage.Rb, 'Ω') });
            }

            // --- Wiring ---

            // Input connection
            if (isFirst) {
                sch.label('In', xOff + 5, sigY + 4);
            }
            sch.wire({ x: xOff + 20, y: sigY }, prefix + 'Z1.a');

            // Z1 -> Vx -> Z2
            sch.wire(prefix + 'Z1.b', { x: xOff + 95, y: sigY });
            sch.wire({ x: xOff + 95, y: sigY }, prefix + 'Z2.a');
            sch.node(xOff + 95, sigY);

            // Z2 -> V+ node -> wire to op-amp plus
            sch.wire(prefix + 'Z2.b', { x: xOff + 210, y: sigY });
            sch.node(xOff + 210, sigY);
            sch.wire({ x: xOff + 210, y: sigY }, prefix + 'U.plus');

            // Z3 feedback: Vx up to Z3, Z3 across to output
            sch.wire({ x: xOff + 95, y: sigY }, { x: xOff + 95, y: fbY });
            sch.wire({ x: xOff + 95, y: fbY }, prefix + 'Z3.a');
            sch.wire(prefix + 'Z3.b', { x: xOff + 410, y: fbY });
            sch.wire({ x: xOff + 410, y: fbY }, { x: xOff + 410, y: 90 });

            // Z4 shunt: V+ down to Z4, Z4 to ground
            sch.wire({ x: xOff + 210, y: sigY }, { x: xOff + 210, y: 116 });
            sch.wire(prefix + 'Z4.b', prefix + 'GND1.a');

            // Gain network wiring
            sch.wire(prefix + 'U.minus', { x: xOff + 260, y: 110 }, { route: 'v-h' });
            sch.wire({ x: xOff + 260, y: 110 }, { x: xOff + 260, y: 195 });
            sch.node(xOff + 260, 195);
            sch.wire({ x: xOff + 260, y: 195 }, prefix + 'Ra.a');
            sch.wire(prefix + 'Ra.b', prefix + 'GND2.a');

            if (stage.Rb > 0) {
                sch.wire({ x: xOff + 260, y: 195 }, prefix + 'Rb.a');
                sch.wire(prefix + 'Rb.b', { x: xOff + 410, y: 195 });
                sch.wire({ x: xOff + 410, y: 90 }, { x: xOff + 410, y: 195 });
            } else {
                sch.wire({ x: xOff + 260, y: 195 }, { x: xOff + 410, y: 195 });
                sch.wire({ x: xOff + 410, y: 90 }, { x: xOff + 410, y: 195 });
                sch.label('(wire)', xOff + 335, 190, { anchor: 'middle' });
            }

            // Output from op-amp
            sch.wire(prefix + 'U.out', { x: xOff + 430, y: 90 });
            sch.node(xOff + 410, 90);

            // Output label only on last stage
            if (isLast) {
                sch.label('Out', xOff + 435, 94);
            }

            // Power rails
            sch.wire(prefix + 'U.vpos', { x: xOff + 330, y: 45 });
            sch.label('+' + vcc + 'V', xOff + 340, 42);
            sch.wire(prefix + 'U.vneg', { x: xOff + 330, y: 135 });
            sch.label('−' + vcc + 'V', xOff + 340, 150);

            // Stage label
            sch.label('Stage ' + stage.stageNum, xOff + 200, 295, { anchor: 'middle', bold: true });
            sch.label('Q=' + stage.Q.toFixed(2) + ' K=' + stage.K.toFixed(2), xOff + 200, 308, { anchor: 'middle' });
        }

        // Calculate magnitude response of a single 2nd-order stage at frequency f
        function stageMagnitude(stage, f) {
            const w = f / stage.fcActual;  // Normalized frequency
            const w2 = w * w;
            const denom = Math.sqrt(Math.pow(1 - w2, 2) + Math.pow(w / stage.Q, 2));

            if (stage.type === 'lowpass') {
                return stage.K / denom;
            } else {
                return stage.K * w2 / denom;
            }
        }

        // Calculate total filter magnitude response at frequency f
        function filterMagnitude(stages, f) {
            let mag = 1;
            for (const stage of stages) {
                mag *= stageMagnitude(stage, f);
            }
            return mag;
        }

        // Draw frequency response plot using Graph class
        function drawFrequencyResponse(stages, responseType, rippleDb, targetFc) {
            const fc = targetFc;
            const fMin = fc / 100;
            const fMax = fc * 100;
            const isLowpass = stages[0].type === 'lowpass';

            // Find normalization factor (peak gain in passband)
            let maxMag = 0;
            for (let i = 0; i <= 100; i++) {
                const f = isLowpass
                    ? fMin + (fc - fMin) * i / 100
                    : fc + (fMax - fc) * i / 100;
                const mag = filterMagnitude(stages, f);
                if (mag > maxMag) maxMag = mag;
            }
            if (maxMag === 0) maxMag = 1;

            // Create graph
            const graph = new Graph({
                xMin: fMin,
                xMax: fMax,
                yMin: -60,
                yMax: 10
            });

            // Generate and add response curve
            const curve = generateResponseCurve(fMin, fMax, f => filterMagnitude(stages, f) / maxMag);
            graph.addCurve(curve);

            // Add reference lines
            graph.addVLine(fc, { color: '#88f', label: 'fc = ' + fmt(fc, 'Hz') });

            if (responseType === 'chebyshev') {
                graph.addHLine(-rippleDb, { color: '#f88', label: '-' + rippleDb + ' dB' });
            } else {
                graph.addHLine(-3, { color: '#f88', label: '-3 dB' });
            }

            return graph.toSVG();
        }

        // Draw all stages in a single horizontal schematic
        function drawAllStages(stages, vcc) {
            const stageWidth = 450;
            const margin = 30;
            const totalWidth = margin + stages.length * stageWidth + margin;
            const sch = new Schematic(totalWidth, 320);

            for (let i = 0; i < stages.length; i++) {
                const xOff = margin + i * stageWidth;
                const isFirst = i === 0;
                const isLast = i === stages.length - 1;
                drawStageAt(sch, stages[i], vcc, xOff, i, isFirst, isLast);

                // Wire between stages (output of this stage to input of next)
                if (!isLast) {
                    const nextXOff = margin + (i + 1) * stageWidth;
                    sch.wire({ x: xOff + 430, y: 90 }, { x: nextXOff + 20, y: 70 }, { route: 'h-v' });
                }
            }

            return sch.toSVG();
        }

        function updateRippleVisibility() {
            const response = document.getElementById('responseType').value;
            document.getElementById('rippleRow').style.display = response === 'chebyshev' ? '' : 'none';
        }

        function calculate() {
            const filterType = document.getElementById('filterType').value;
            const responseType = document.getElementById('responseType').value;
            const order = parseInt(document.getElementById('order').value);
            const fc = parseFloat(document.getElementById('fc').value);
            const cInput = parseFloat(document.getElementById('cval').value) * 1e-9;
            const vcc = parseFloat(document.getElementById('vcc').value);
            const rippleDb = parseFloat(document.getElementById('ripple').value);

            const C = roundCap(cInput);

            let stages;
            if (responseType === 'chebyshev') {
                stages = chebyshevFilter(filterType, order, fc, C, rippleDb);
            } else {
                stages = butterworthFilter(filterType, order, fc, C);
            }

            if (!stages) {
                document.getElementById('warning').textContent = 'Invalid order selected';
                document.getElementById('warning').classList.remove('hidden');
                return;
            }

            // Check for warnings
            let warnings = [];
            for (const stage of stages) {
                if (stage.R > 1e6) {
                    warnings.push(`Stage ${stage.stageNum}: R too high (${fmtLong(stage.R, 'Ω')}). Try larger C.`);
                }
                if (stage.R < 100) {
                    warnings.push(`Stage ${stage.stageNum}: R too low (${fmtLong(stage.R, 'Ω')}). Try smaller C.`);
                }
            }

            const warn = document.getElementById('warning');
            if (warnings.length > 0) {
                warn.innerHTML = warnings.join('<br>');
                warn.classList.remove('hidden');
            } else {
                warn.classList.add('hidden');
            }

            // Calculate total gain
            const totalGain = stages.reduce((g, s) => g * s.K, 1);

            // Summary
            const responseLabel = responseType === 'chebyshev'
                ? `Chebyshev (${rippleDb} dB ripple)`
                : 'Butterworth';
            document.getElementById('summaryType').textContent =
                filterType.charAt(0).toUpperCase() + filterType.slice(1) + ' / ' + responseLabel;
            document.getElementById('summaryOrder').textContent = order + ' (' + stages.length + ' stage' + (stages.length > 1 ? 's' : '') + ')';
            document.getElementById('summaryFc').textContent = fmtLong(stages[0].fcActual, 'Hz');
            document.getElementById('summaryRolloff').textContent = '-' + (order * 6) + ' dB/octave (-' + (order * 20) + ' dB/decade)';
            document.getElementById('summaryGain').textContent = totalGain.toFixed(2) + ' V/V (' + (20 * Math.log10(totalGain)).toFixed(1) + ' dB)';

            // Draw combined schematic
            const stagesDiv = document.getElementById('stages');
            stagesDiv.innerHTML = '';

            const schematicDiv = document.createElement('div');
            schematicDiv.className = 'overflow-x-auto p-2.5 border border-gray-300 bg-gray-50 my-2.5';
            schematicDiv.innerHTML = drawAllStages(stages, vcc);
            stagesDiv.appendChild(schematicDiv);

            // Component values table
            const tableDiv = document.createElement('div');
            tableDiv.className = 'flex flex-wrap gap-5 my-2.5';

            for (const stage of stages) {
                const stageDiv = document.createElement('div');
                stageDiv.className = 'p-2.5 border border-gray-200 bg-gray-50';

                const title = document.createElement('div');
                title.className = 'font-bold mb-1';
                title.textContent = 'Stage ' + stage.stageNum + ' (Q = ' + stage.targetQ.toFixed(4) + ')';
                stageDiv.appendChild(title);

                const table = document.createElement('table');
                table.innerHTML = `
                    <tr><td class="py-1 pr-3">R (x2):</td><td class="py-1 font-mono">${fmtLong(stage.R, 'Ω')}</td></tr>
                    <tr><td class="py-1 pr-3">C (x2):</td><td class="py-1 font-mono">${fmtLong(stage.C, 'F')}</td></tr>
                    <tr><td class="py-1 pr-3">Ra:</td><td class="py-1 font-mono">${fmtLong(stage.Ra, 'Ω')}</td></tr>
                    <tr><td class="py-1 pr-3">Rb:</td><td class="py-1 font-mono">${stage.Rb > 0 ? fmtLong(stage.Rb, 'Ω') : 'wire (0)'}</td></tr>
                    <tr><td class="py-1 pr-3">Gain (K):</td><td class="py-1 font-mono">${stage.K.toFixed(3)}</td></tr>
                    <tr><td class="py-1 pr-3">Actual Q:</td><td class="py-1 font-mono">${stage.Q.toFixed(3)}</td></tr>
                    <tr><td class="py-1 pr-3">Actual fc:</td><td class="py-1 font-mono">${fmtLong(stage.fcActual, 'Hz')}</td></tr>
                `;
                stageDiv.appendChild(table);

                tableDiv.appendChild(stageDiv);
            }

            stagesDiv.appendChild(tableDiv);

            // Draw frequency response
            const responseDiv = document.getElementById('response');
            responseDiv.innerHTML = drawFrequencyResponse(stages, responseType, rippleDb, fc);
        }

        function resetDefaults() {
            document.getElementById('filterType').value = 'lowpass';
            document.getElementById('responseType').value = 'butterworth';
            document.getElementById('ripple').value = '1';
            document.getElementById('order').value = '2';
            document.getElementById('fc').value = '1000';
            document.getElementById('cval').value = '10';
            document.getElementById('vcc').value = '12';
            updateRippleVisibility();
            calculate();
        }

        window.onload = calculate;
    </script>
</body>
</html>
